---
title: "ML - PMI rat brain- validation - pos"
author: "IMML"
date: " updated : `r Sys.time()`"
output: 
  html_document:
    code_folding: hide
    theme: cosmo
    toc: yes
editor_options: 
  chunk_output_type: console
---

```{r, message=F, warning=F}

# Initialization

## Turning off warnings and messages in output

knitr::opts_chunk$set(message=F)
knitr::opts_chunk$set(warning=F)

## Loading required packages
library(tidyverse)
library(cowplot)
library(ggsci)
library(Hmisc)
library(kableExtra)
library(dplyr)
library(xlsx)
library(caret)
library(randomForest)
library(glmnet)
library(e1071)
library(ggplot2)
library(SuperLearner)
library(pROC)
library(ROCR)
library(ranger)
library(lightgbm)


## Configuration of output format etc.

options(digits = 5)        # number of digits printed by R default (vectors, data.frames, lists)
options(pillar.sigfig = 5) # number of digits printed by tibbles default.

text_base_size   <- 8   # in pt
fig.witdh        <- 200  # in mm
fig.height       <- 150  # in mm

# Set all text in plots to same size
theme_set(theme_cowplot(font_size = text_base_size, rel_small = 1, rel_tiny = 1, rel_large = 1))

# Setting output sizes for plots
knitr::opts_chunk$set(fig.width = fig.witdh/25.4)
knitr::opts_chunk$set(fig.height = fig.height/25.4)
knitr::opts_chunk$set(dpi = 108) # You need to find your minotors dpi yourself.

# Setting text size inside plots (geom_text, geom_label etc.)
ggplot_text_size <- text_base_size / ggplot2::.pt
# Now use: geom_text(..., size = ggplot_text_size)

# For saving plots!
# Use: ggsave(plot1, filename="myplot.png", width = fig.witdh, height=fig.height, units = "mm")
# Use: ggsave(plot1, filename="myplot.pdf", width = fig.witdh, height=fig.height, units = "mm")

# Changing default ggplot colours
# see ?scale_fill_continuous
options(ggplot2.continuous.fill  = scale_fill_viridis_c)    
options(ggplot2.discrete.fill    = list(ggsci::pal_locuszoom()(7)) )
options(ggplot2.continuous.colour = scale_colour_viridis_c)
options(ggplot2.discrete.colour   = list(ggsci::pal_locuszoom()(7)))

## Set locale if you want Danish/English month names etc.

#x <- Sys.setlocale(locale = "Danish_Denmark")  # For Danish axes on plot
x <- Sys.setlocale(locale = "English_Denmark")  # For English axes on plot
rm(x)


```


```{r setseed}

set.seed(0)

```

# Load data
```{r Load data}

#Loading and formatting:
Raw_data <- readRDS("./2_Data normalization/Brain/PMI_rat_brain_stable_features_normalized_batchnorm.rds")

Raw_data <- Raw_data[,-1]

CAMERA_info <- Raw_data[80:nrow(Raw_data),]

Raw_data <- Raw_data[-c(80:nrow(Raw_data)),]


imp_features <- read_tsv(file = "./3_ML/Brain/Lasso/results_brain_full.tsv")
imp_features <- imp_features$name

filtered_brain <- Raw_data[, colnames(Raw_data) %in% imp_features]

filtered_brain <- cbind(Raw_data[,1:15], filtered_brain)


# Evt fjerne replicates først
Data_u_rep <- filtered_brain %>%
  filter(str_detect(Unique_ID, "rep"))

Data_u_rep <- Data_u_rep[-c(2, 12, 15),]

Data_u_rep <- anti_join(filtered_brain, Data_u_rep, by = "Unique_ID")

Data_u_rep <- Data_u_rep[-c(53:66),]

Data_u_rep <- Data_u_rep%>%
  select( -Unique_ID, -Tissue_ID, -Rat_ID, -Batch, -Type, -Type2, -Death_manner, -Room_Temperature, -Sampling_order, -PMI_group, -group_id, -Info, -i)

Data_u_rep$Time_since_death_h <- as.numeric(Data_u_rep$Time_since_death_h)
Data_u_rep <- Data_u_rep %>% mutate(across(starts_with("M"), as.numeric))

```

```{r Load data RF}

#Loading and formatting:
imp_features_RF <- read_tsv(file = "./3_ML/Brain/Trees/results_RF_brain_full.tsv")
imp_features_RF <- imp_features_RF$name

filtered_brain_RF <- Raw_data[, colnames(Raw_data) %in% imp_features_RF]

filtered_brain_RF <- cbind(Raw_data[,1:15], filtered_brain_RF)


# Evt fjerne replicates først
Data_u_rep_RF <- filtered_brain_RF %>%
  filter(str_detect(Unique_ID, "rep"))

Data_u_rep_RF <- Data_u_rep_RF[-c(2, 12, 15),]

Data_u_rep_RF <- anti_join(filtered_brain_RF, Data_u_rep_RF, by = "Unique_ID")

Data_u_rep_RF <- Data_u_rep_RF[-c(53:66),]

Data_u_rep_RF <- Data_u_rep_RF%>%
  select( -Unique_ID, -Tissue_ID, -Rat_ID, -Batch, -Type, -Type2, -Death_manner, -Room_Temperature, -Sampling_order, -PMI_group, -group_id, -Info, -i)

Data_u_rep_RF$Time_since_death_h <- as.numeric(Data_u_rep_RF$Time_since_death_h)
Data_u_rep_RF <- Data_u_rep_RF %>% mutate(across(starts_with("M"), as.numeric))


```


```{r Load validation data lasso}

#Loading and formatting:
raw_val_data <- readRDS("./2_Data normalization/Brain/PMI_rat_brain_validation_stable_features_normalized_batchnorm.rds")

raw_val_data <- raw_val_data[,-1]

CAMERA_info_val <- raw_val_data[15:nrow(raw_val_data),]

raw_val_data <- raw_val_data[-c(11:nrow(raw_val_data)),-c(1)]


names <- Data_u_rep[,1:ncol(Data_u_rep)] %>% names()

val_data_lasso <- raw_val_data[, which((names(raw_val_data) %in% names)== TRUE)]


val_data_lasso$Time_since_death_h <- as.numeric(val_data_lasso$Time_since_death_h)
val_data_lasso <- val_data_lasso %>% mutate(across(starts_with("M"), as.numeric))

```

```{r Load validation data RF}

#Loading and formatting:
raw_val_data_RF <- readRDS("./2_Data normalization/Brain/PMI_rat_brain_validation_stable_features_normalized_batchnorm.rds")

raw_val_data_RF <- raw_val_data_RF[,-1]

CAMERA_info_val_RF <- raw_val_data_RF[15:nrow(raw_val_data_RF),]

raw_val_data_RF <- raw_val_data_RF[-c(11:nrow(raw_val_data_RF)),-c(1)]


names_RF <- Data_u_rep_RF[,1:ncol(Data_u_rep_RF)] %>% names()

val_data_RF <- raw_val_data_RF[, which((names(raw_val_data_RF) %in% names_RF)== TRUE)]


val_data_RF$Time_since_death_h <- as.numeric(val_data_RF$Time_since_death_h)
val_data_RF <- val_data_RF %>% mutate(across(starts_with("M"), as.numeric))


```



```{r Lasso - LOROCV}
#LASSO - Leave one rat out cross validation

lambda.grid <- expand.grid(alpha=1, lambda=10^seq(-5,0, length=50))



x_train <- Data_u_rep %>% select(-Sample_ID, -Time_since_death_h)%>% as_tibble()
x_train <- lapply(x_train, as.numeric)%>%
  as.data.frame()

y_train <- Data_u_rep$Time_since_death_h


lasso.model.full <- caret::train(x = x_train, y = y_train,
                         method = "glmnet",
                         tuneGrid = lambda.grid, 
                         trControl = caret::trainControl(method="cv")
                         )

x_val <- val_data_lasso[,3:ncol(val_data_lasso)]

x_val <- lapply(x_val, as.numeric)%>%
  as.data.frame()


validation <- predict(object = lasso.model.full, newdata = x_val, type = "raw")

result <- list()
result[[length(result)+1]] <- tibble("predicted_PMI"= validation, "observed_PMI"=val_data_lasso$Time_since_death_h)
  

result_val <- bind_rows(result)

result_val <- cbind(val_data_lasso$Sample_ID, result_val)

result_val <- result_val%>%
  mutate(`Difference (h)` = result_val$observed_PMI - result_val$predicted_PMI)

print(result_val)
```


```{r Random Forest}
#RF

x_train_RF <- Data_u_rep_RF %>% select(-Sample_ID, -Time_since_death_h)%>% as_tibble()
x_train_RF <- lapply(x_train_RF, as.numeric)%>%
  as.data.frame()

y_train_RF <- Data_u_rep_RF$Time_since_death_h


tune_grid <-  expand.grid(mtry=15, 
                         splitrule=c("variance", "extratrees"), 
                         min.node.size=c(3,5,7))

folds <- caret::createMultiFolds(1:nrow(x_train_RF), k = 10, times=1)

train_control <- caret::trainControl(method="cv", index = folds, verboseIter = F)


RF.model.full <- caret::train(x = as.matrix(x_train_RF), 
                           y = y_train_RF, 
                    tuneGrid = tune_grid,
                   trControl = train_control,
                      method = "ranger"
                  )


x_val_RF <- val_data_RF[,3:ncol(val_data_RF)]

x_val_RF <- lapply(x_val_RF, as.numeric)%>%
  as.data.frame()


validation_RF <- predict(object = RF.model.full, newdata = x_val_RF, type = "raw")

result_RF <- list()
result_RF[[length(result_RF)+1]] <- tibble("predicted_PMI"= validation_RF, "observed_PMI"=val_data_RF$Time_since_death_h)
  

result_val_RF <- bind_rows(result_RF)

result_val_RF <- cbind(val_data_RF$Sample_ID, result_val_RF)

result_val_RF <- result_val_RF%>%
  mutate(`Difference (h)` = result_val_RF$observed_PMI - result_val_RF$predicted_PMI)

print(result_val_RF)

    
```



```{r save result}

df_lasso <- cbind(result_val, raw_val_data)

df_lasso <- df_lasso[,-1]

df_lasso$method <-c("Lasso")

df_lasso <- df_lasso%>%
  select(method, everything())




df_Rf <- cbind(result_val_RF, raw_val_data_RF)

df_Rf <- df_Rf[,-1]

df_Rf$method <-c("Random Forest")

df_Rf <- df_Rf%>%
  select(method, everything())


df <- rbind(df_lasso, df_Rf)


write_tsv(df, file="./3_ML/Brain/results_brain_validation_lasso_RF.tsv")


```

